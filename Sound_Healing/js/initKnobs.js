import { clamp } from 'https://cdn.jsdelivr.net/gh/phish83/Malay@main/Sound_Healing/js/utils.js';
const DEG_MIN=-135, DEG_MAX=135;
function syncNeedleForInput(input){ const container = document.querySelector(`.knob-container[data-knob-for="${input.id}"]`); if (!container) return; const min = (input.min !== '' ? parseFloat(input.min) : 0); const max = (input.max !== '' ? parseFloat(input.max) : 100); const val = clamp(parseFloat(input.value), min, max); const pct = (val - min) / (max - min || 1); const ang = DEG_MIN + pct * (DEG_MAX - DEG_MIN); const needle = container.querySelector('.needle'); if (needle) needle.style.transform = `translateX(-50%) rotate(${ang}deg)`; }
function setVal(input, v, fire=true){ const min = (input.min !== '' ? parseFloat(input.min) : -Infinity); const max = (input.max !== '' ? parseFloat(input.max) : Infinity); const step = (input.step && input.step !== 'any') ? parseFloat(input.step) : null; let val = clamp(parseFloat(v), min, max); if (step && isFinite(step)) { const base = (input.min !== '' ? parseFloat(input.min) : 0); val = Math.round((val - base) / step) * step + base; val = parseFloat(val.toFixed(6)); } input.value = val; if (fire) input.dispatchEvent(new Event('input', { bubbles: true })); syncNeedleForInput(input); }
function attachKnob(container){ const targetId = container.getAttribute('data-knob-for'); const input = document.getElementById(targetId); if (!input) return; if (!input.hasAttribute('data-default')) input.setAttribute('data-default', input.value); syncNeedleForInput(input); let dragging=false, startY=0, startVal=0; const min = (input.min !== '' ? parseFloat(input.min) : 0); const max = (input.max !== '' ? parseFloat(input.max) : 100); const range = Math.max(1, max - min); const pxFullRange = Math.max(60, 120 * (range <= 200 ? 1 : (range <= 2000 ? 0.6 : 0.35))); function onPointerDown(e){ dragging=true; startY=e.clientY; startVal=parseFloat(input.value); container.setPointerCapture?.(e.pointerId); e.preventDefault(); } function onPointerMove(e){ if(!dragging) return; const dy=startY-e.clientY; const delta=(dy/pxFullRange)*range; setVal(input, startVal + delta, true); e.preventDefault(); } function onPointerUp(e){ dragging=false; try{container.releasePointerCapture?.(e.pointerId);}catch{} } function onDblClick(){ setVal(input, input.getAttribute('data-default') ?? input.getAttribute('value') ?? input.value, true); } function onWheel(e){ e.preventDefault(); const baseStep=(input.step && input.step!=='any')?parseFloat(input.step):(input.type==='number'?1:0.01); const accel=e.altKey?1:(e.shiftKey?40:16); const dir=Math.sign(-e.deltaY||e.wheelDelta||0); setVal(input, parseFloat(input.value)+baseStep*accel*dir, true); } container.addEventListener('pointerdown', onPointerDown); window.addEventListener('pointermove', onPointerMove); window.addEventListener('pointerup', onPointerUp); container.addEventListener('dblclick', onDblClick); container.addEventListener('wheel', onWheel, { passive: false }); input.addEventListener('input', ()=> syncNeedleForInput(input)); }
export function initKnobs(){ document.querySelectorAll('.knob-container[data-knob-for]').forEach(attachKnob); }
export { syncNeedleForInput };
